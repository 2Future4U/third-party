---

 
copyright:

  years: 2017, 2018

lastupdated: "2018-09-05" 

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:tip: .tip}
{:new_window: target="_blank"}

# 従量制プランの使用量の送信
{: #submitusage}

すべてのアクティブ・サービス・インスタンスの使用量を毎時送信する必要があります。 使用量を報告しないと、IBM にとっての収益の損失につながり、それによってオファリング・プロバイダーの分配収益の損失が発生する可能性があります。
{:shortdesc}

## プロセスの仕組み
{: #process-flow}

以下のステップでは、使用量の送信プロセスの概要について説明します。

1. 使用量送信 REST API ツールを使用して初期使用量テストを送信し、従量制プランが正しく構成されていることを確認します。
2. 従量制プランごとに使用量送信 Rest API ツールへの継続的な毎時送信を自動化します。 標準の SSO がサポートされている限り、いつでも必要な場所で、これらの自動化された送信をホストできます。
2. 使用量記録は計量モデルに基づいて集計され、{{site.data.keyword.Bluemix_notm}} コンソールの使用状況ダッシュボードに総量が表示されます。
3. 計量プロセスから集計された単位量が使用され、コストが適用され、サービス・インスタンスに対するユーザーの支払い金額が計算されます。
4. 月末に最終的に計算されたコストが、ユーザーに対して生成される金額です。

## 前提条件
{: #prereqs}

サービスの計量を有効にするには、以下の前提条件を確認してください。

* 料金カタログが、リソースのプラン内のすべての課金可能メトリックの料金によって更新されている。
* リソース内のすべてのプランの計量およびレーティングの定義が検証され、オンボーディングされている。

## 使用量を送信するためのガイドライン 
{: #metering_guidelines}

### 送信のガイドライン
{: #submission-guidelines}

{{site.data.keyword.Bluemix_notm}} 計量サービスを使用してリソース使用量データを送信するときは、以下のガイドラインを参照してください。

* 開始時刻と終了時刻は、測定値が収集された時刻範囲を示します。 これらの時刻は、使用量記録が計量 API に送信される時刻に依存しません。
* 使用量記録は事実です。 使用量記録を作成後に更新しないでください。 使用量記録を正常に作成するとロケーションが指定されます。 エラー・コードが返される場合は、実行が必要な可能性がある[アクション](#actions)を参照してください。
* 使用量記録は、シグニチャー `account_id/resource_group_id/resource_instance_id/consumer_id/plan_id/region/start/end` によって一意的に識別されます。 使用量記録が処理されると、同じシグニチャーを持つ他の使用量記録は重複として拒否されます。
* 計量サービスとの相互作用を他のどのサービスとも組み合わせないでください。 計量の開始と終了がインスタンスのプロビジョニングとプロビジョニング解除で行われる場合でも、要求は個別に処理する必要があります。
* リソース使用量データは、2 時間から 24 時間ごとに 1 回、計量サービスに送信する必要があります。 使用量データの送信頻度は、使用量メトリックの変更頻度によって決まります。
* 使用量記録は、測定が完了した時刻から 2 日以内に送信する必要があります。 それより古い使用量記録は拒否されます。
* 送信が正常に行われると、応答コード 201 が返されます。 それ以外の応答コードが返される場合は、201 コードを受信するまでデータの更新と再送信を行ってください。

以下は、使用量の送信に関するベスト・プラクティスです。

* ユーザーがリソースを消費した時刻から、コストがユーザーのアカウントに反映されるまでの時刻で多大な遅延がユーザーに示されることのないように、サービス・プロバイダーは使用量を 1 時間ごとに送信することが推奨されます。
* 使用量記録の送信の再試行は、直前の要求で本当の障害が発生した場合にのみ行ってください。 正常に受け入れられた使用量記録は再送信しないでください。

### サービス ID のガイドライン
{: #id-guidelines}

  リソース定義の ID フィールドを使用してサービス ID を指定するときは、以下のガイドラインに従う必要があります。
  * ID は、英数字で開始します。
  * 文字 A から Z、a から z、および 0 から 9 を使用します。 使用できる特殊文字は、ハイフン (-) とアンダースコアー (_) のみです。
  * ID に複数のワードが含まれている場合は、キャメル・ケース規則に従ってください。
  * ID の最大長は 50 文字になるようにしてください。

### リソース名のガイドライン
{: #resource-name}

  リソース定義の resources.name フィールドを使用してリソース名を指定するときは、以下のガイドラインに従う必要があります。

  * ご使用のリソースを記述するワードのみを使用します。 例えば、**Storage** または **ApiCalls** など。 
  * 名前に複数のワードが含まれている場合は、キャメル・ケース規則に従ってください。
  * 名前の先頭文字は大文字にしてください。

### リソース単位名のガイドライン
{: #resource-unti}

  リソース定義の resources.unit.name フィールドを使用してリソース単位名を指定するときは、以下のガイドラインに従う必要があります。

  * 単位名には 1 ワードを使用し、複数のワードを分離するには、スペースの代わりにアンダースコアー (_) を使用します。 例えば、**API CALL**ではなく、**API_CALL** と指定します。  
  * 名前のすべての文字を大文字にします。
  
### リソース単位の数量のガイドライン
{: #unit-quantity}

  リソース定義の resources.unit.quantityType フィールドを使用してリソース数量のタイプを指定するときは、以下のガイドラインに従う必要があります。
  
  * 数量タイプには 1 ワードを使用します。
  * 数量タイプのすべての文字を大文字にします。
  
### 集計 ID のガイドライン
{: #aggregation}

  リソース定義の aggregations.id フィールドを使用して集計 ID を指定するときは、以下のガイドラインに従う必要があります。

  * 数量タイプのすべての文字を大文字にします。
  * 複数のワードを分離するには、スペースではなく、アンダースコアー (_) を使用します。
  * この ID は、aggregations.unit の値で開始されているか、その値に一致するようにしてください。 例えば、aggregations.id には **API_CALLS_PER_MONTH** を指定し、aggregations.unit には **API_CALLS** を指定することができます。

### 集計単位のガイドライン
{: #aggregation-unit}

  リソース定義の aggregations.unit フィールドを使用して集計単位を指定するときは、以下のガイドラインに従う必要があります。
   
  * 単位名の単数形を使用します。
  * 単位名のすべての文字を大文字にします。
  * aggregations.unit フィールドに指定する単位名は resources.unit.name フィールドに指定する単位名の集計であることを確認します。
  
### 集計グループのガイドライン
{: #aggregation-group}

  リソース定義の aggregations.aggregationGroup フィールドには小文字を使用する必要があります。
  
### 集計公式のガイドライン
{: #aggregation-formula}

  リソース定義の aggregations.formula フィールドでは、公式で算術演算を使用する場合、1 つのオペランドとしてリソース単位を使用し、その公式の関数で中置演算式を使用する必要があります。 例えば、Bytes を Megabytes に変換するには、以下の公式を使用できます。
  ```
  SUM({BYTE}/1048576)
  ```

## 使用量送信 REST API
{: #RAPIusesubmit}

{{site.data.keyword.Bluemix_notm}} ユーザーは、使用したリソース量に基づいて課金されます。 例えば、データベース・サービスを使用するユーザーは、アプリケーションが使用するストレージの量に基づいて課金される可能性があります。

{{site.data.keyword.Bluemix_notm}} 計量サービスを使用して使用量データを報告するには、計量サービス API を実装してオファリングの使用量データを報告します。 詳しくは、[public API documentation](https://ibm-bluemix-docs.github.io/usage-submission/) を参照してください。  

計量サービス API を使用して、毎時の使用量送信を自動化する必要があります。 自動化送信は、公衆インターネットでアクセスできる任意の有効 HTTPS エンドポイントでホストできます。
{: tip}

## 使用量記録の送信
{: #usage-records}

使用量記録は、メトリックの集計値に提供される最も小さなエンティティーです。 使用量記録は、以下のフィールドを使用して作成されます。

| 名前 | 説明                                           |
| ------ | ---------------------------------------------------- |
| resource_instance_id |  リソース・インスタンスの ID。  |
| plan_id | 使用量記録の集計およびレーティングに使用される契約。   |
| start  | 使用量の測定が開始される時刻。エポックからのミリ秒で指定されます。  |
| end  | 使用量の測定が終了する時刻。エポックからのミリ秒で指定されます。  |
| region  | 使用量が測定されるオファリング・プロバイダーの地域。  |
| measured_usage  | 一連の測定値。  |
| consumer_id | オプション。 このフィールドは、コンシューマー・レベルで集計が必要な場合にのみ必要です。 consumer_id 値を知っているのはオファリング・プロバイダーのみです。 |
{: caption="表 1. 使用量記録のフィールド" caption-side="top"}

API 呼び出しを使用して複数の使用量記録を送信でき、1 回の呼び出しで最大 100 個の使用量記録を送信できます。 応答本文には、すべての使用量記録の受け入れ状況が含まれます。 201 以外のすべての状況には、エラー・コードが付属して、その使用量記録が受け入れられない理由を示しています。 以下の表に、状況コードと必要なアクションをリストします。

| 状況コード | 必要なアクション                                       |
| ------ | ---------------------------------------------------- |
| 500 |  使用量記録の送信を再試行してください。 問題が続く場合は、BSS 計量チームに連絡してください。 |
| 400 |  使用量記録の形式が正しくありません。 スキーマ検証が失敗したか、使用量記録の測定値が正しくないか、開始時刻と終了時刻が、プロビジョンされた時刻とプロビジョン解除された時刻の間に入っていません。 使用量記録を更新し、再送信してください。   |
| 424  | リソース・インスタンスのメタデータにいくつかの問題があります。 リソース・インスタンスの詳細を更新し、使用量記録を再送信してください。  |
| 404  | 計量定義がオンボーディングされませんでした。 BSS 計量チームと協力してリソースがオンボーディングされているかどうか確認し、使用量記録を再送信してください。  |
| 409  | 使用量記録が重複しています。 再送信を試行しないでください。 |
{: caption="表 2. 状況コードと必要なアクション" caption-side="top"}
{: #actions}


  
