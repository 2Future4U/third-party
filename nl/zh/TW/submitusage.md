---

 
copyright:

  years: 2017, 2019

lastupdated: "2019-04-04" 

keywords: plans of the resource, use characters A, usage records, metered plans, submitting usage 

subcollection: third-party

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:tip: .tip}
{:new_window: target="_blank"}

# 提交計量方案的用量
{: #submitusage}

您需要每小時提交所有作用中服務實例的用量。不報告用量可能會導致 IBM 的收入集合的損失，進而導致供應項目提供者的收入分潤損失。
{:shortdesc}

## 處理程序運作方式
{: #process-flow}

下列步驟概述提交用量的處理程序：

1. 透過「用量提交 REST API」工具提交起始用量測試，驗證已正確地配置計量方案。
2. 針對每一個計量方案，連續每小時自動提交至「用量提交 REST API」工具。只要支援標準 SSO，就可以在您想要的任何位置管理這些自動化提交。
3. 用量記錄是根據計量模型所聚集，而數量總計會顯示在 {{site.data.keyword.Bluemix_notm}} 主控台的「用量儀表板」上。
4. 會使用計量處理程序中的聚集單位數量、套用成本，並且計算服務實例使用者積欠的金額。
5. 在月底，最終計算成本就是針對使用者所產生的金額。

## 必要條件
{: #prereqs}

請檢閱下列啟用服務計量的必要條件：

* 使用資源方案中所有可收費度量值的價格來更新定價型錄。
* 已驗證資源中所有方案的計量及分級定義，並將其上線。

## 用量提交準則 
{: #metering_guidelines}

### 提交準則
{: #submission-guidelines}

當您使用 {{site.data.keyword.Bluemix_notm}} 計量服務來提交資源用量資料時，請參閱下列準則：

* 開始時間和結束時間代表收集測量值的時間範圍。這些時間與將用量記錄提交至計量 API 的時間無關。
* 用量記錄是事實資料。請不要在建立用量記錄之後更新該記錄。當您順利建立用量記錄時，會指定位置。如果傳回錯誤碼，則請參閱[狀態碼及您可能需要採取的必要動作](/docs/third-party?topic=third-party-submitusage#usage-records)。
* 用量記錄是依簽章 `account_id/resource_group_id/resource_instance_id/consumer_id/plan_id/region/start/end` 進行唯一識別。處理用量記錄時，會將任何具有相同簽章的其他用量記錄視為重複項目而加以拒絶。
* 不要將與計量服務的互動與任何其他服務結合。即使計量會隨著佈建與取消佈建實例而開始及結束，也必須個別處理這些要求。
* 資源用量資料每隔 2 - 24 小時都必須提交至計量服務一次。用量資料的提交頻率取決於用量度量值的變更頻率。
* 用量記錄必須在完成測量時算起的兩天內提交。較舊的用量記錄會遭到拒絕。
* 成功提交的話會傳回回應碼 201。如果傳回任何其他回應碼，則請更新並重新傳送資料，直到您收到 201 代碼為止。

以下是提交用量的最佳作法：

* 建議服務提供者每 1 小時提交一次用量，以便一般使用者不會看到使用資源的時間與在其帳戶中反映成本的時間之間有大量延遲。
* 只有在前一個要求發生真正的失敗時，才重試提交用量記錄。請不要重新提交已順利接受的用量記錄。

### 服務 ID 準則
{: #id-guidelines}

  當您使用資源定義中的 ID 欄位來指定服務 ID 時，必須遵循這些準則：
  * ID 開頭使用英數字元。
  * 使用字元 A - Z、a - z 及 0 - 9。您可以使用的特殊字元只有連字號 (-) 及底線 (_)。
  * 如果 ID 包含多個單字，則請遵循駝峰式大小寫慣例。
  * 確定 ID 的長度上限是 50 個字元。

### 資源名稱準則
{: #resource-name}

  當您使用資源定義中的 resources.name 欄位來指定資源名稱時，必須遵循這些準則：

  * 只使用說明您資源的單字。例如，**Storage** 或 **ApiCalls**。 
  * 如果名稱包含多個單字，則請遵循駝峰式大小寫慣例。
  * 將名稱的第一個字元大寫。

### 資源單位名稱準則
{: #resource-unti}

  當您使用資源定義中的 resources.unit.name 欄位來指定資源單位名稱時，必須遵循這些準則：

  * 使用一個單字作為單位名稱，並使用底線 (_) 來區隔單字，而不要使用空格。例如，指定 **API_CALL**，而非 **API CALL**。  
  * 將名稱的所有字母大寫。
  
### 資源單位數量準則
{: #unit-quantity}

  當您使用資源定義中的 resources.unit.quantityType 欄位來指定資源單位數量類型時，必須遵循這些準則：
  
  * 使用一個單字作為數量類型。
  * 將數量類型的所有字母大寫。
  
### 聚集 ID 準則
{: #aggregation}

  當您使用資源定義中的 aggregations.id 欄位來指定聚集 ID 時，必須遵循這些準則：

  * 將數量類型的所有字母大寫。
  * 使用底線 (_) 來區隔單字，而不要使用空格。
  * 確定此 ID 開頭為 aggregations.unit 的值或與之相符。例如，您可以針對 aggregations.id 指定 **API_CALLS_PER_MONTH**，並針對 aggregations.unit 指定 **API_CALLS**。

### 聚集單位準則
{: #aggregation-unit}

  當您使用資源定義中的 aggregations.unit 欄位來指定聚集單位時，必須遵循這些準則：
   
  * 使用單位名稱的單數形式。
  * 將單位名稱的所有字母大寫。
  * 確定您在 aggregations.unit 欄位中指定的單位名稱，是您在 resources.unit.name 欄位中指定的單位名稱聚集。
  
### 聚集群組準則
{: #aggregation-group}

  您必須在資源定義中，針對 aggregations.aggregationGroup 欄位使用小寫字母。
  
### 聚集公式準則
{: #aggregation-formula}

  對於資源定義中的 aggregations.formula 欄位，如果您要在公式中使用算術運算，則必須使用資源單位作為一個運算元，並在公式的函數中使用中綴的算術表示式。例如，您可以使用下列公式將「位元組」轉換為 MB：
  ```
  SUM({BYTE}/1048576)
  ```

## 用量提交 REST API
{: #RAPIusesubmit}

會根據 {{site.data.keyword.Bluemix_notm}} 使用者所使用的資源數量來向他們收費。例如，可能會根據使用資料庫服務之使用者的應用程式所用儲存空間數量，向這些使用者收費。

若要使用 {{site.data.keyword.Bluemix_notm}} 計量服務來報告用量資料，請實作計量服務 API 以報告供應項目的用量資料。如需詳細資訊，請參閱[公用 API 文件](https://ibm-bluemix-docs.github.io/usage-submission/){: new_window} ![外部鏈結圖示](../icons/launch-glyph.svg "外部鏈結圖示")。  

您需要使用計量服務 API 自動執行每小時用量提交。您可以在公用網際網路上可存取的任何有效 HTTPS 端點上管理自動化提交。
{: tip}

## 提交用量記錄
{: #usage-records}

用量記錄是影響度量值聚集值的最小實體。使用下列欄位來建構用量記錄：

| 名稱 | 說明                                                  |
| ------ | ---------------------------------------------------- |
| resource_instance_id | 資源實例的 ID。|
| plan_id | 用來聚集及分級用量記錄的合約。|
| start  | 開始測量用量的時間（以自新紀元後的毫秒數指定）。|
| end  | 結束測量用量的時間（以自新紀元後的毫秒數指定）。|
| region  | 在其中測量用量的供應項目提供者地區。|
| measured_usage  |含有值的測量值陣列。|
| consumer_id |選用。只有需要在消費者層次進行聚集時，才需要此欄位。只有供應項目提供者知道 consumer_id 值。|
{: caption="表 1. 用量記錄的欄位" caption-side="top"}

您可以使用 API 呼叫來提交多筆用量記錄，而且每個呼叫最多可以提交 100 筆用量記錄。回應內文包含每筆用量記錄的接受狀態。201 以外的任何狀態都會隨附錯誤碼，並指出為何不接受該用量記錄。下表列出狀態碼及必要動作。

| 狀態碼      | 必要動作                                              |
| ------ | ---------------------------------------------------- |
| 500 | 嘗試重新提交用量記錄。如果問題持續發生，請與 BSS 計量團隊聯絡。|
| 400 | 用量記錄的格式不正確。綱目驗證失敗、用量記錄中的測量值不正確，或是開始及結束時間未落在已佈建與已取消佈建時間之間。更新用量記錄並重新提交。|
| 424  | 資源實例 meta 資料有一些問題。更新資源實例詳細資料，並重新提交用量記錄。|
| 404  | 尚未將計量定義上線。與 BSS 計量團隊合作，確認資源是否已上線，並重新提交用量記錄。|
| 409  | 用量記錄重複。不要嘗試重新提交。|
{: caption="表 2. 狀態碼及必要動作" caption-side="top"}
{: #actions}


  
