---

 
copyright:

  years: 2017, 2019

lastupdated: "2019-06-05" 

keywords: plans of the resource, use characters A, usage records, metered plans, submitting usage 

subcollection: third-party

---

{:shortdesc: .shortdesc}
{:codeblock: .codeblock}
{:screen: .screen}
{:tip: .tip}
{:new_window: target="_blank"}

# 提交计量套餐的使用量
{: #submitusage}

您需要每小时提交一次所有活动服务实例的使用量。不报告使用量会导致 IBM 的收入损失，这可能导致产品提供者的收入份额损失。
{:shortdesc}

## 过程工作方式
{: #process-flow}

以下步骤概述了提交使用量的过程：

1. 通过“使用量提交 REST API”工具提交初始使用量测试，以验证是否正确配置了计量套餐。
2. 向“使用量提交 REST API”工具自动连续提交每个计量套餐的每小时使用量。可以在支持标准 SSO 的任何位置托管这些自动提交。
3. 使用量记录将根据计量模型进行聚集，并且总数量将显示在 {{site.data.keyword.Bluemix_notm}} 控制台中的“使用情况仪表板”上。
4. 将使用计量过程中的聚集单位数量，应用成本，并计算用户对服务实例的欠费金额。
5. 在月底，最终计算的成本即为向用户生成的金额。

## 先决条件
{: #prereqs}

查看针对服务启用计量的以下先决条件：

* 使用资源套餐中所有可收费度量值的价格更新定价目录。
* 验证并上线资源中所有套餐的计量和费率定义。

## 使用量提交准则 
{: #metering_guidelines}

### 提交准则
{: #submission-guidelines}

使用 {{site.data.keyword.Bluemix_notm}} 计量服务来提交资源使用量数据时，请参阅以下准则：

* 开始时间和结束时间表示收集度量的时间范围。这些时间与将使用量记录提交给计量 API 的时间无关。
* 使用量记录是事实。创建使用量记录后，不要对其进行更新。成功创建使用量记录时会指定位置。如果返回错误代码，请查看[状态码和必需操作](/docs/third-party?topic=third-party-submitusage#usage-records)（这些可能是必须执行的操作）。
* 使用量记录由 `account_id/resource_group_id/resource_instance_id/consumer_id/plan_id/region/start/end` 特征符进行唯一标识。处理某个使用量记录时，具有相同特征符的其他任何使用量记录都将作为重复项而被拒绝。
* 与计量服务的交互不应与其他任何服务组合使用。即使计量以供应和取消供应实例来开始和结束，也必须单独处理请求。
* 资源使用量数据必须每 2 - 24 小时向计量服务提交一次。提交使用量数据的频率取决于使用量度量值的更改频率。
* 使用量记录必须在度量完成后的两天内提交。系统会拒绝超过此时间提交的使用量记录。
* 成功提交将返回响应代码 201。如果返回其他任何响应代码，请更新并重新发送数据，直到收到 201 代码。

下面是提交使用量的最佳做法：

* 建议服务提供者每小时提交一次使用量，这样用户就不会看到从资源使用到成本反映在其帐户中之间出现极大延迟。
* 仅当先前请求确实失败时，才重试提交使用量记录。不要重新提交已成功接受的使用量记录。

### 服务标识准则
{: #id-guidelines}

  使用资源定义中的 ID 字段来指定服务标识时，必须遵循以下准则：
  * 标识以字母数字字符开头。
  * 使用字符 A - Z、a - z 和 0 - 9。唯一可以使用的特殊字符是连字符 (-) 和下划线 (_)。
  * 如果标识包含多个词，请遵循驼峰式大小写约定。
  * 确保标识的最大长度为 50 个字符。

### 资源名称准则
{: #resource-name}

  使用资源定义中的 resources.name 字段来指定资源名称时，必须遵循以下准则：

  * 仅使用描述资源的词。例如，**Storage** 或 **ApiCalls**。 
  * 如果名称包含多个词，请遵循驼峰式大小写约定。
  * 名称的第一个字符大写。

### 资源单位名称准则
{: #resource-unti}

  使用资源定义中的 resources.unit.name 字段来指定资源单位名称时，必须遵循以下准则：

  * 对单位名称使用一个词，并使用下划线 (_) 而不是空格来分隔多个词。例如，指定 **API_CALL**，而不要指定 **API CALL**。  
  * 名称的所有字母均为大写。
  
### 资源单位数量准则
{: #unit-quantity}

  使用资源定义中的 resources.unit.quantityType 字段来指定资源单位数量类型时，必须遵循以下准则：
  
  * 对数量类型使用一个词。
  * 数量类型的所有字母均为大写。
  
### 聚集标识准则
{: #aggregation}

  使用资源定义中的 aggregations.id 字段来指定聚集标识时，必须遵循以下准则：

  * 数量类型的所有字母均为大写。
  * 使用下划线 (_) 而不是空格来分隔多个词。
  * 确保此标识以 aggregations.unit 的值开头或与此值相匹配。例如，可以为 aggregations.id 指定 **API_CALLS_PER_MONTH**，为 aggregations.unit 指定 **API_CALLS**。

### 聚集单位准则
{: #aggregation-unit}

  使用资源定义中的 aggregations.unit 字段来指定聚集单位时，必须遵循以下准则：
   
  * 对单位名称使用单数形式。
  * 单位名称的所有字母均为大写。
  * 确保在 aggregations.unit 字段中指定的单位名称是在 resources.unit.name 字段中指定的单位名称的聚集。
  
### 聚集组准则
{: #aggregation-group}

  对于资源定义中的 aggregations.aggregationGroup 字段，必须使用小写字母。
  
### 聚集公式准则
{: #aggregation-formula}

  对于资源定义中的 aggregations.formula 字段，如果要在公式中使用算术运算，那么必须使用资源单位作为一个操作数，并在公式函数中使用中缀算术表达式。例如，可以使用以下公式将字节转换为兆字节：
  ```
  SUM({BYTE}/1048576)
  ```

## 使用量提交 REST API
{: #RAPIusesubmit}

将根据 {{site.data.keyword.Bluemix_notm}} 用户使用的资源量向用户收费。例如，对于使用数据库服务的用户，可能会根据其应用程序使用的存储量对这些用户收费。

要使用 {{site.data.keyword.Bluemix_notm}} 计量服务来报告使用量数据，请实现计量服务 API 以报告产品的使用量数据。有关更多详细信息，请参阅[公共 API 文档](https://ibm-bluemix-docs.github.io/usage-submission/){: new_window} ![外部链接图标](../icons/launch-glyph.svg "外部链接图标")。  

您需要使用计量服务 API 来自动执行每小时使用量提交。可以在可通过公用因特网访问的任何有效 HTTPS 端点上托管自动提交。
{: tip}

## 提交使用量记录
{: #usage-records}

使用量记录是构成度量值的聚集值的最小实体。下表提供了有关用于构造使用量记录的字段的信息：

|名称|描述
|
| ------ | ---------------------------------------------------- |
|resource_instance_id|资源实例的标识。|
|plan_id|用于对使用量记录进行聚集和确定费率的合同。|
|start|度量使用量的开始时间，以系统纪元以来的毫秒数为单位指定。|
|end|度量使用量的结束时间，以系统纪元以来的毫秒数为单位指定。|
|区域 (region)|在其中度量使用量的产品提供者区域。|
|measured_usage|度量及其值的数组。|
|consumer_id|可选。仅当在使用者级别需要聚集时，才需要此字段。只有产品提供者知道 consumer_id 值。|
{: caption="表 1. 使用量记录的字段" caption-side="top"}

可以使用 API 调用来提交多个使用量记录，每次调用最多可以提交 100 个使用量记录。响应主体包括每个使用量记录的接受状态。除 201 以外的其他任何状态都随附错误代码，并指示不接受使用量记录的原因。下表列出了状态码和必需的操作。

|状态码|必需的操作|
| ------ | ---------------------------------------------------- |
|500|重试提交使用量记录。如果问题仍然存在，请联系 BSS 计量组。|
|400|使用量记录的格式不正确。模式验证失败，使用量记录中的度量不正确，或者开始时间和结束时间不在供应时间和取消供应时间之间。请更新使用量记录，然后重新提交。|
|424|资源实例元数据存在一些问题。请更新资源实例详细信息，然后重新提交使用量记录。|
|404|计量定义未上线。请与 BSS 计量团队合作，检查是否资源已上线，然后重新提交使用量记录。|
|409|使用量记录重复。不要重试提交此记录。|
{: caption="表 2. 状态码和必需的操作" caption-side="top"}
{: #actions}


  
